"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { createClient } from "@/lib/supabase/client";

export default function SignupPage() {
  const supabase = createClient();
    const router = useRouter();

      const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
          const [username, setUsername] = useState("");
            const [loading, setLoading] = useState(false);

              async function handleSignup(e: React.FormEvent) {
                  e.preventDefault();

                      if (!username) {
                            alert("Please enter username");
                                  return;
                                      }

                                          setLoading(true);

                                              try {
                                                    // 1. Create auth user
                                                          const { data, error } = await supabase.auth.signUp({
                                                                  email,
                                                                          password,
                                                                                });

                                                                                      if (error) {
                                                                                              alert(error.message);
                                                                                                      setLoading(false);
                                                                                                              return;
                                                                                                                    }

                                                                                                                          const user = data.user;

                                                                                                                                if (!user) {
                                                                                                                                        alert("Signup failed");
                                                                                                                                                setLoading(false);
                                                                                                                                                        return;
                                                                                                                                                              }

                                                                                                                                                                    // 2. Create profile with user-typed username
                                                                                                                                                                          const { error: profileError } = await supabase
                                                                                                                                                                                  .from("profiles")
                                                                                                                                                                                          .insert({
                                                                                                                                                                                                    user_id: user.id,
                                                                                                                                                                                                              username: username.toLowerCase(),
                                                                                                                                                                                                                        display_name: username,
                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                      if (profileError) {
                                                                                                                                                                                                                                              alert(profileError.message);
                                                                                                                                                                                                                                                      setLoading(false);
                                                                                                                                                                                                                                                              return;
                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                          // 3. Redirect to dashboard
                                                                                                                                                                                                                                                                                router.push("/dashboard");

                                                                                                                                                                                                                                                                                    } catch (err) {
                                                                                                                                                                                                                                                                                          console.error(err);
                                                                                                                                                                                                                                                                                                alert("Unexpected error occurred");
                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                        setLoading(false);
                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                            return (
                                                                                                                                                                                                                                                                                                                <div className="flex min-h-screen items-center justify-center">
                                                                                                                                                                                                                                                                                                                      <form
                                                                                                                                                                                                                                                                                                                              onSubmit={handleSignup}
                                                                                                                                                                                                                                                                                                                                      className="w-full max-w-md space-y-4 p-6 border rounded-lg"
                                                                                                                                                                                                                                                                                                                                            >
                                                                                                                                                                                                                                                                                                                                                    <h1 className="text-2xl font-bold">Create your account</h1>

                                                                                                                                                                                                                                                                                                                                                            <input
                                                                                                                                                                                                                                                                                                                                                                      type="text"
                                                                                                                                                                                                                                                                                                                                                                                placeholder="Username (this becomes your public URL)"
                                                                                                                                                                                                                                                                                                                                                                                          value={username}
                                                                                                                                                                                                                                                                                                                                                                                                    onChange={(e) => setUsername(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                              required
                                                                                                                                                                                                                                                                                                                                                                                                                        className="w-full border p-2 rounded"
                                                                                                                                                                                                                                                                                                                                                                                                                                />

                                                                                                                                                                                                                                                                                                                                                                                                                                        <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                  type="email"
                                                                                                                                                                                                                                                                                                                                                                                                                                                            placeholder="Email"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      value={email}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                onChange={(e) => setEmail(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="w-full border p-2 rounded"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              type="password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        placeholder="Password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  value={password}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onChange={(e) => setPassword(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                className="w-full border p-2 rounded"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          type="submit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    disabled={loading}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className="w-full bg-blue-600 text-white p-2 rounded"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {loading ? "Creating account..." : "Sign Up"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }