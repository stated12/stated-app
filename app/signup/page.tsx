"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";

export default function SignupPage() {

  const router = useRouter();

    const [username, setUsername] = useState("");
      const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");

          const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

              const handleSignup = async (e: React.FormEvent) => {

                  e.preventDefault();

                      setError("");
                          setLoading(true);

                              try {

                                    // Step 1: check username already exists
                                          const { data: existingUsername } = await supabase
                                                  .from("profiles")
                                                          .select("id")
                                                                  .eq("username", username)
                                                                          .maybeSingle();

                                                                                if (existingUsername) {
                                                                                        setError("Username already exists. Please choose another username.");
                                                                                                setLoading(false);
                                                                                                        return;
                                                                                                              }

                                                                                                                    // Step 2: create auth user
                                                                                                                          const { data, error: signupError } = await supabase.auth.signUp({
                                                                                                                                  email,
                                                                                                                                          password,
                                                                                                                                                });

                                                                                                                                                      if (signupError) {

                                                                                                                                                              if (signupError.message.toLowerCase().includes("already registered")) {
                                                                                                                                                                        setError("Email already exists. Please login or use another email.");
                                                                                                                                                                                } else {
                                                                                                                                                                                          setError(signupError.message);
                                                                                                                                                                                                  }

                                                                                                                                                                                                          setLoading(false);
                                                                                                                                                                                                                  return;
                                                                                                                                                                                                                        }

                                                                                                                                                                                                                              const user = data.user;

                                                                                                                                                                                                                                    if (!user) {
                                                                                                                                                                                                                                            setError("Signup failed. Please try again.");
                                                                                                                                                                                                                                                    setLoading(false);
                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                        // Step 3: create profile row
                                                                                                                                                                                                                                                                              const { error: profileError } = await supabase
                                                                                                                                                                                                                                                                                      .from("profiles")
                                                                                                                                                                                                                                                                                              .insert({
                                                                                                                                                                                                                                                                                                        id: user.id,
                                                                                                                                                                                                                                                                                                                  username: username,
                                                                                                                                                                                                                                                                                                                            display_name: username,
                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                          if (profileError) {

                                                                                                                                                                                                                                                                                                                                                  if (profileError.message.includes("profiles_username_key")) {
                                                                                                                                                                                                                                                                                                                                                            setError("Username already exists. Please choose another username.");
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                            else {
                                                                                                                                                                                                                                                                                                                                                                                      setError("Failed to create profile. Please try again.");
                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                      setLoading(false);
                                                                                                                                                                                                                                                                                                                                                                                                              return;
                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                          // Step 4: success â†’ redirect
                                                                                                                                                                                                                                                                                                                                                                                                                                router.push("/dashboard");

                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                        catch (err) {

                                                                                                                                                                                                                                                                                                                                                                                                                                              setError("Something went wrong. Please try again.");

                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                      setLoading(false);
                                                                                                                                                                                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                                                                                                                                                                                          return (

                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div style={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    maxWidth: 400,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          margin: "60px auto",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                padding: 20
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }}>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <h1>Create your account</h1>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <form onSubmit={handleSignup}>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <label>Username</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        value={username}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    onChange={(e) => setUsername(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            style={{ width: "100%", padding: 8, marginBottom: 12 }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <label>Email</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      type="email"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  value={email}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onChange={(e) => setEmail(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      style={{ width: "100%", padding: 8, marginBottom: 12 }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <label>Password</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                type="password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            value={password}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        onChange={(e) => setPassword(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                style={{ width: "100%", padding: 8, marginBottom: 12 }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {error && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <p style={{ color: "red", marginBottom: 12 }}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {error}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    type="submit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              disabled={loading}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        style={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    width: "100%",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                padding: 10,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            background: "#2563eb",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        color: "white",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    border: "none",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                borderRadius: 6
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {loading ? "Creating account..." : "Create account"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </form>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }