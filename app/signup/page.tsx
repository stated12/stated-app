"use client";

import { useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { useRouter } from "next/navigation";

export default function SignupPage() {
  const supabase = createClientComponentClient();
    const router = useRouter();

      const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
          const [username, setUsername] = useState("");
            const [loading, setLoading] = useState(false);
              const [error, setError] = useState("");

                const handleSignup = async (e: React.FormEvent) => {
                    e.preventDefault();
                        setLoading(true);
                            setError("");

                                // 1️⃣ Check if username already exists
                                    const { data: existingUser } = await supabase
                                          .from("profiles")
                                                .select("id")
                                                      .eq("username", username)
                                                            .single();

                                                                if (existingUser) {
                                                                      setError("Username already taken");
                                                                            setLoading(false);
                                                                                  return;
                                                                                      }

                                                                                          // 2️⃣ Create auth user
                                                                                              const { data, error: signupError } = await supabase.auth.signUp({
                                                                                                    email,
                                                                                                          password,
                                                                                                              });

                                                                                                                  if (signupError) {
                                                                                                                        setError(signupError.message);
                                                                                                                              setLoading(false);
                                                                                                                                    return;
                                                                                                                                        }

                                                                                                                                            const user = data.user;
                                                                                                                                                if (!user) {
                                                                                                                                                      setError("Signup failed.");
                                                                                                                                                            setLoading(false);
                                                                                                                                                                  return;
                                                                                                                                                                      }

                                                                                                                                                                          // 3️⃣ Insert profile with user typed username
                                                                                                                                                                              const { error: profileError } = await supabase.from("profiles").insert({
                                                                                                                                                                                    user_id: user.id,
                                                                                                                                                                                          username: username.toLowerCase(),
                                                                                                                                                                                                display_name: username,
                                                                                                                                                                                                    });

                                                                                                                                                                                                        if (profileError) {
                                                                                                                                                                                                              setError(profileError.message);
                                                                                                                                                                                                                    setLoading(false);
                                                                                                                                                                                                                          return;
                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                  router.push("/dashboard");
                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                      return (
                                                                                                                                                                                                                                          <div className="p-6">
                                                                                                                                                                                                                                                <h1 className="text-xl font-bold mb-4">Signup</h1>

                                                                                                                                                                                                                                                      <form onSubmit={handleSignup} className="space-y-3">
                                                                                                                                                                                                                                                              <input
                                                                                                                                                                                                                                                                        type="text"
                                                                                                                                                                                                                                                                                  placeholder="Username (this will be your public URL)"
                                                                                                                                                                                                                                                                                            value={username}
                                                                                                                                                                                                                                                                                                      onChange={(e) => setUsername(e.target.value)}
                                                                                                                                                                                                                                                                                                                required
                                                                                                                                                                                                                                                                                                                          className="border p-2 w-full"
                                                                                                                                                                                                                                                                                                                                  />

                                                                                                                                                                                                                                                                                                                                          <input
                                                                                                                                                                                                                                                                                                                                                    type="email"
                                                                                                                                                                                                                                                                                                                                                              placeholder="Email"
                                                                                                                                                                                                                                                                                                                                                                        value={email}
                                                                                                                                                                                                                                                                                                                                                                                  onChange={(e) => setEmail(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                            required
                                                                                                                                                                                                                                                                                                                                                                                                      className="border p-2 w-full"
                                                                                                                                                                                                                                                                                                                                                                                                              />

                                                                                                                                                                                                                                                                                                                                                                                                                      <input
                                                                                                                                                                                                                                                                                                                                                                                                                                type="password"
                                                                                                                                                                                                                                                                                                                                                                                                                                          placeholder="Password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                    value={password}
                                                                                                                                                                                                                                                                                                                                                                                                                                                              onChange={(e) => setPassword(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  className="border p-2 w-full"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {error && <p className="text-red-500">{error}</p>}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    type="submit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              disabled={loading}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className="bg-black text-white px-4 py-2"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {loading ? "Creating..." : "Create Account"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }