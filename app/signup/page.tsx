"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";

export default function SignupPage() {
  const router = useRouter();

    const [username, setUsername] = useState("");
      const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");

          const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

              const handleSignup = async (e: any) => {
                  e.preventDefault();

                      setError("");
                          setLoading(true);

                              try {
                                    // check username exists
                                          const { data: existingUsername } = await supabase
                                                  .from("profiles")
                                                          .select("id")
                                                                  .eq("username", username)
                                                                          .maybeSingle();

                                                                                if (existingUsername) {
                                                                                        setError("Username already exists. Please choose another.");
                                                                                                setLoading(false);
                                                                                                        return;
                                                                                                              }

                                                                                                                    // check email exists
                                                                                                                          const { data: existingEmail } = await supabase
                                                                                                                                  .from("profiles")
                                                                                                                                          .select("id")
                                                                                                                                                  .eq("email", email)
                                                                                                                                                          .maybeSingle();

                                                                                                                                                                if (existingEmail) {
                                                                                                                                                                        setError("Email already registered. Please login.");
                                                                                                                                                                                setLoading(false);
                                                                                                                                                                                        return;
                                                                                                                                                                                              }

                                                                                                                                                                                                    // create auth user
                                                                                                                                                                                                          const { data: authData, error: authError } =
                                                                                                                                                                                                                  await supabase.auth.signUp({
                                                                                                                                                                                                                            email,
                                                                                                                                                                                                                                      password,
                                                                                                                                                                                                                                              });

                                                                                                                                                                                                                                                    if (authError) {
                                                                                                                                                                                                                                                            setError(authError.message);
                                                                                                                                                                                                                                                                    setLoading(false);
                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                        const user = authData.user;

                                                                                                                                                                                                                                                                                              if (!user) {
                                                                                                                                                                                                                                                                                                      setError("Signup failed. Please try again.");
                                                                                                                                                                                                                                                                                                              setLoading(false);
                                                                                                                                                                                                                                                                                                                      return;
                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                  // insert profile
                                                                                                                                                                                                                                                                                                                                        const { error: profileError } = await supabase
                                                                                                                                                                                                                                                                                                                                                .from("profiles")
                                                                                                                                                                                                                                                                                                                                                        .insert({
                                                                                                                                                                                                                                                                                                                                                                  id: user.id,
                                                                                                                                                                                                                                                                                                                                                                            username,
                                                                                                                                                                                                                                                                                                                                                                                      email,
                                                                                                                                                                                                                                                                                                                                                                                              });

                                                                                                                                                                                                                                                                                                                                                                                                    if (profileError) {
                                                                                                                                                                                                                                                                                                                                                                                                            setError("Could not create profile. Try again.");
                                                                                                                                                                                                                                                                                                                                                                                                                    setLoading(false);
                                                                                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                        // SUCCESS â†’ redirect
                                                                                                                                                                                                                                                                                                                                                                                                                                              router.push("/dashboard");

                                                                                                                                                                                                                                                                                                                                                                                                                                                  } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                        setError("Unexpected error occurred.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                setLoading(false);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="flex justify-center items-center min-h-screen">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <form
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      onSubmit={handleSignup}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className="bg-white p-6 rounded shadow w-80"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h2 className="text-xl mb-4">Create your account</h2>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              type="text"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        placeholder="Username"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  className="border p-2 w-full mb-3"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            value={username}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      onChange={(e) => setUsername(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          type="email"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    placeholder="Email"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className="border p-2 w-full mb-3"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        value={email}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  onChange={(e) => setEmail(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      type="password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                placeholder="Password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          className="border p-2 w-full mb-3"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    value={password}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onChange={(e) => setPassword(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {error && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <p className="text-red-500 text-sm mb-3">{error}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            type="submit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      disabled={loading}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                className="bg-blue-600 text-white w-full p-2 rounded"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {loading ? "Creating..." : "Create account"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }