"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { createClient } from "@/lib/supabase/client";

export default function SignupPage() {
  const router = useRouter();
    const supabase = createClient();

      const [username, setUsername] = useState("");
        const [email, setEmail] = useState("");
          const [password, setPassword] = useState("");
            const [error, setError] = useState("");
              const [loading, setLoading] = useState(false);

                const handleSignup = async (e: any) => {
                    e.preventDefault();

                        setError("");
                            setLoading(true);

                                try {
                                      // STEP 1: Check if username exists
                                            const { data: existingUsername } = await supabase
                                                    .from("profiles")
                                                            .select("id")
                                                                    .eq("username", username)
                                                                            .maybeSingle();

                                                                                  if (existingUsername) {
                                                                                          setError("Username already exists. Please choose another.");
                                                                                                  setLoading(false);
                                                                                                          return;
                                                                                                                }

                                                                                                                      // STEP 2: Create Auth user
                                                                                                                            const { data: authData, error: authError } =
                                                                                                                                    await supabase.auth.signUp({
                                                                                                                                              email,
                                                                                                                                                        password,
                                                                                                                                                                });

                                                                                                                                                                      if (authError) {
                                                                                                                                                                              if (authError.message.includes("already registered")) {
                                                                                                                                                                                        setError("Email already exists. Please login instead.");
                                                                                                                                                                                                } else {
                                                                                                                                                                                                          setError(authError.message);
                                                                                                                                                                                                                  }
                                                                                                                                                                                                                          setLoading(false);
                                                                                                                                                                                                                                  return;
                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                              const user = authData.user;

                                                                                                                                                                                                                                                    if (!user) {
                                                                                                                                                                                                                                                            setError("Signup failed. Please try again.");
                                                                                                                                                                                                                                                                    setLoading(false);
                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                        // STEP 3: Insert profile
                                                                                                                                                                                                                                                                                              const { error: profileError } = await supabase
                                                                                                                                                                                                                                                                                                      .from("profiles")
                                                                                                                                                                                                                                                                                                              .insert({
                                                                                                                                                                                                                                                                                                                        id: user.id,
                                                                                                                                                                                                                                                                                                                                  username: username,
                                                                                                                                                                                                                                                                                                                                            display_name: username,
                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                          if (profileError) {
                                                                                                                                                                                                                                                                                                                                                                  console.error(profileError);
                                                                                                                                                                                                                                                                                                                                                                          setError("Could not create profile. Try different username.");
                                                                                                                                                                                                                                                                                                                                                                                  setLoading(false);
                                                                                                                                                                                                                                                                                                                                                                                          return;
                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                      // STEP 4: Redirect immediately
                                                                                                                                                                                                                                                                                                                                                                                                            router.push("/dashboard");

                                                                                                                                                                                                                                                                                                                                                                                                                } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                      console.error(err);
                                                                                                                                                                                                                                                                                                                                                                                                                            setError("Unexpected error occurred.");
                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                    setLoading(false);
                                                                                                                                                                                                                                                                                                                                                                                                                                      };

                                                                                                                                                                                                                                                                                                                                                                                                                                        return (
                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex min-h-screen items-center justify-center bg-gray-50">
                                                                                                                                                                                                                                                                                                                                                                                                                                                  <form
                                                                                                                                                                                                                                                                                                                                                                                                                                                          onSubmit={handleSignup}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  className="bg-white p-8 rounded-lg shadow-md w-full max-w-md"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <h1 className="text-2xl font-bold mb-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Create your account
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </h1>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <label className="block mb-2">Username</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            type="text"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                value={username}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          onChange={(e) => setUsername(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="w-full border p-2 rounded mb-4"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <label className="block mb-2">Email</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      type="email"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          value={email}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    onChange={(e) => setEmail(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className="w-full border p-2 rounded mb-4"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <label className="block mb-2">Password</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                type="password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    value={password}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onChange={(e) => setPassword(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className="w-full border p-2 rounded mb-4"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {error && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <p className="text-red-500 mb-4">{error}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            type="submit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      disabled={loading}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                className="w-full bg-blue-600 text-white p-2 rounded"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {loading ? "Creating account..." : "Create account"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }