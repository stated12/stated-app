"use client";

import { useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { useRouter } from "next/navigation";

export default function SignupPage() {
  const router = useRouter();

    const [username, setUsername] = useState("");
      const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
          const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

              const handleSignup = async (e: React.FormEvent) => {
                  e.preventDefault();

                      setError("");
                          setLoading(true);

                              try {
                                    // Step 1: Create auth user
                                          const { data: authData, error: authError } = await supabase.auth.signUp({
                                                  email,
                                                          password,
                                                                });

                                                                      if (authError) {
                                                                              setError(authError.message);
                                                                                      setLoading(false);
                                                                                              return;
                                                                                                    }

                                                                                                          const user = authData.user;

                                                                                                                if (!user) {
                                                                                                                        setError("User creation failed");
                                                                                                                                setLoading(false);
                                                                                                                                        return;
                                                                                                                                              }

                                                                                                                                                    // Step 2: Insert profile using SAME ID
                                                                                                                                                          const { error: profileError } = await supabase
                                                                                                                                                                  .from("profiles")
                                                                                                                                                                          .insert([
                                                                                                                                                                                    {
                                                                                                                                                                                                id: user.id, // VERY IMPORTANT
                                                                                                                                                                                                            username: username,
                                                                                                                                                                                                                        display_name: username,
                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                          ]);

                                                                                                                                                                                                                                                if (profileError) {
                                                                                                                                                                                                                                                        setError(profileError.message);
                                                                                                                                                                                                                                                                setLoading(false);
                                                                                                                                                                                                                                                                        return;
                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                    // Step 3: Redirect
                                                                                                                                                                                                                                                                                          router.push("/dashboard");

                                                                                                                                                                                                                                                                                              } catch (err) {
                                                                                                                                                                                                                                                                                                    setError("Unexpected error");
                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                            setLoading(false);
                                                                                                                                                                                                                                                                                                              };

                                                                                                                                                                                                                                                                                                                return (
                                                                                                                                                                                                                                                                                                                    <div style={{ maxWidth: 400, margin: "50px auto" }}>
                                                                                                                                                                                                                                                                                                                          <h2>Create your account</h2>

                                                                                                                                                                                                                                                                                                                                <form onSubmit={handleSignup}>

                                                                                                                                                                                                                                                                                                                                        <input
                                                                                                                                                                                                                                                                                                                                                  type="text"
                                                                                                                                                                                                                                                                                                                                                            placeholder="Username"
                                                                                                                                                                                                                                                                                                                                                                      value={username}
                                                                                                                                                                                                                                                                                                                                                                                required
                                                                                                                                                                                                                                                                                                                                                                                          onChange={(e) => setUsername(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                    style={{ width: "100%", padding: 10, marginBottom: 10 }}
                                                                                                                                                                                                                                                                                                                                                                                                            />

                                                                                                                                                                                                                                                                                                                                                                                                                    <input
                                                                                                                                                                                                                                                                                                                                                                                                                              type="email"
                                                                                                                                                                                                                                                                                                                                                                                                                                        placeholder="Email"
                                                                                                                                                                                                                                                                                                                                                                                                                                                  value={email}
                                                                                                                                                                                                                                                                                                                                                                                                                                                            required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      onChange={(e) => setEmail(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                style={{ width: "100%", padding: 10, marginBottom: 10 }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          type="password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    placeholder="Password"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              value={password}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  onChange={(e) => setPassword(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            style={{ width: "100%", padding: 10, marginBottom: 10 }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {error && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <p style={{ color: "red" }}>{error}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                type="submit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          disabled={loading}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    style={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                width: "100%",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            padding: 10,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        background: "#2563eb",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    color: "white",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                border: "none",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {loading ? "Creating..." : "Create account"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }