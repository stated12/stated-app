"use client";

import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import Link from "next/link";
import { useRouter } from "next/navigation";

export default function Dashboard() {
  const router = useRouter();

    const [user, setUser] = useState<any>(null);
      const [profile, setProfile] = useState<any>(null);
        const [credits, setCredits] = useState<number>(0);
          const [commitments, setCommitments] = useState<any[]>([]);
            const [loading, setLoading] = useState(true);

              useEffect(() => {
                  loadDashboard();
                    }, []);

                      async function loadDashboard() {
                          const {
                                data: { user },
                                    } = await supabase.auth.getUser();

                                        if (!user) {
                                              router.push("/login");
                                                    return;
                                                        }

                                                            setUser(user);

                                                                // load profile
                                                                    const { data: profileData } = await supabase
                                                                          .from("profiles")
                                                                                .select("*")
                                                                                      .eq("id", user.id)
                                                                                            .single();

                                                                                                setProfile(profileData);

                                                                                                    // load credits
                                                                                                        const { data: creditData } = await supabase
                                                                                                              .from("credits")
                                                                                                                    .select("credits_remaining")
                                                                                                                          .eq("user_id", user.id)
                                                                                                                                .single();

                                                                                                                                    if (creditData) setCredits(creditData.credits_remaining);

                                                                                                                                        // load commitments
                                                                                                                                            const { data: commitmentData } = await supabase
                                                                                                                                                  .from("commitments")
                                                                                                                                                        .select("*")
                                                                                                                                                              .eq("user_id", user.id)
                                                                                                                                                                    .order("created_at", { ascending: false });

                                                                                                                                                                        setCommitments(commitmentData || []);

                                                                                                                                                                            setLoading(false);
                                                                                                                                                                              }

                                                                                                                                                                                async function logout() {
                                                                                                                                                                                    await supabase.auth.signOut();
                                                                                                                                                                                        router.push("/login");
                                                                                                                                                                                          }

                                                                                                                                                                                            async function updateStatus(id: string, status: string) {
                                                                                                                                                                                                await supabase
                                                                                                                                                                                                      .from("commitments")
                                                                                                                                                                                                            .update({ status })
                                                                                                                                                                                                                  .eq("id", id);

                                                                                                                                                                                                                      loadDashboard();
                                                                                                                                                                                                                        }

                                                                                                                                                                                                                          if (loading) return <p>Loading...</p>;

                                                                                                                                                                                                                            return (
                                                                                                                                                                                                                                <div style={{ padding: 20 }}>

                                                                                                                                                                                                                                      <h1>Dashboard</h1>

                                                                                                                                                                                                                                            <p>
                                                                                                                                                                                                                                                    Public profile:{" "}
                                                                                                                                                                                                                                                            <Link href={`/u/${profile.username}`}>
                                                                                                                                                                                                                                                                      /u/{profile.username}
                                                                                                                                                                                                                                                                              </Link>
                                                                                                                                                                                                                                                                                    </p>

                                                                                                                                                                                                                                                                                          <p>Credits remaining: {credits}</p>

                                                                                                                                                                                                                                                                                                <Link href="/dashboard/create">
                                                                                                                                                                                                                                                                                                        <button>Create Commitment</button>
                                                                                                                                                                                                                                                                                                              </Link>

                                                                                                                                                                                                                                                                                                                    <button onClick={logout}>Logout</button>

                                                                                                                                                                                                                                                                                                                          <h2>Your Commitments</h2>

                                                                                                                                                                                                                                                                                                                                {commitments.length === 0 && (
                                                                                                                                                                                                                                                                                                                                        <p>No commitments yet</p>
                                                                                                                                                                                                                                                                                                                                              )}

                                                                                                                                                                                                                                                                                                                                                    {commitments.map((c) => (
                                                                                                                                                                                                                                                                                                                                                            <div
                                                                                                                                                                                                                                                                                                                                                                      key={c.id}
                                                                                                                                                                                                                                                                                                                                                                                style={{
                                                                                                                                                                                                                                                                                                                                                                                            border: "1px solid #ccc",
                                                                                                                                                                                                                                                                                                                                                                                                        padding: 10,
                                                                                                                                                                                                                                                                                                                                                                                                                    marginTop: 10,
                                                                                                                                                                                                                                                                                                                                                                                                                              }}
                                                                                                                                                                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                                                                                                                                                                <p>{c.text}</p>

                                                                                                                                                                                                                                                                                                                                                                                                                                                          <p>Status: {c.status}</p>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                onClick={() => updateStatus(c.id, "active")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Active
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </button>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      onClick={() => updateStatus(c.id, "paused")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Pause
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </button>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onClick={() => updateStatus(c.id, "completed")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Complete
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ))}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }