"use client";

import { useEffect, useState } from "react";
import { createClient } from "../../lib/supabase/client";
import { useRouter } from "next/navigation";

export default function DashboardPage() {

  const supabase = createClient();
    const router = useRouter();

      const [loading, setLoading] = useState(true);
        const [profile, setProfile] = useState<any>(null);
          const [credits, setCredits] = useState(0);
            const [commitments, setCommitments] = useState<any[]>([]);

              useEffect(() => {
                  loadDashboard();
                    }, []);

                      async function loadDashboard() {

                          const { data: userData } = await supabase.auth.getUser();

                              if (!userData?.user) {
                                    router.push("/login");
                                          return;
                                              }

                                                  const userId = userData.user.id;

                                                      // Load profile
                                                          const { data: profileData } = await supabase
                                                                .from("profiles")
                                                                      .select("*")
                                                                            .eq("id", userId)
                                                                                  .single();

                                                                                      if (profileData) {
                                                                                            setProfile(profileData);
                                                                                                }

                                                                                                    // Load credits
                                                                                                        const { data: creditData } = await supabase
                                                                                                              .from("credits")
                                                                                                                    .select("credits_remaining")
                                                                                                                          .eq("user_id", userId)
                                                                                                                                .single();

                                                                                                                                    if (creditData) {
                                                                                                                                          setCredits(creditData.credits_remaining);
                                                                                                                                              }

                                                                                                                                                  // Load commitments
                                                                                                                                                      const { data: commitmentsData } = await supabase
                                                                                                                                                            .from("commitments")
                                                                                                                                                                  .select("*")
                                                                                                                                                                        .eq("user_id", userId)
                                                                                                                                                                              .order("created_at", { ascending: false });

                                                                                                                                                                                  if (commitmentsData) {
                                                                                                                                                                                        setCommitments(commitmentsData);
                                                                                                                                                                                            }

                                                                                                                                                                                                setLoading(false);
                                                                                                                                                                                                  }

                                                                                                                                                                                                    function goToCreate() {
                                                                                                                                                                                                        router.push("/dashboard/create");
                                                                                                                                                                                                          }

                                                                                                                                                                                                            async function logout() {
                                                                                                                                                                                                                await supabase.auth.signOut();
                                                                                                                                                                                                                    router.push("/login");
                                                                                                                                                                                                                      }

                                                                                                                                                                                                                        if (loading) {
                                                                                                                                                                                                                            return (
                                                                                                                                                                                                                                  <div style={{ padding: 20 }}>
                                                                                                                                                                                                                                          Loading dashboard...
                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                        return (
                                                                                                                                                                                                                                                            <div style={{ padding: 20, maxWidth: 600 }}>

                                                                                                                                                                                                                                                                  <h1>Dashboard</h1>

                                                                                                                                                                                                                                                                        {profile && (
                                                                                                                                                                                                                                                                                <div style={{ marginBottom: 20 }}>
                                                                                                                                                                                                                                                                                          <p>
                                                                                                                                                                                                                                                                                                      Public profile:
                                                                                                                                                                                                                                                                                                                  <b> /u/{profile.username}</b>
                                                                                                                                                                                                                                                                                                                            </p>
                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                          )}

                                                                                                                                                                                                                                                                                                                                                <p>
                                                                                                                                                                                                                                                                                                                                                        Credits remaining: <b>{credits}</b>
                                                                                                                                                                                                                                                                                                                                                              </p>

                                                                                                                                                                                                                                                                                                                                                                    <button
                                                                                                                                                                                                                                                                                                                                                                            onClick={goToCreate}
                                                                                                                                                                                                                                                                                                                                                                                    style={{
                                                                                                                                                                                                                                                                                                                                                                                              marginTop: 10,
                                                                                                                                                                                                                                                                                                                                                                                                        padding: "10px 16px",
                                                                                                                                                                                                                                                                                                                                                                                                                  backgroundColor: "#2563eb",
                                                                                                                                                                                                                                                                                                                                                                                                                            color: "white",
                                                                                                                                                                                                                                                                                                                                                                                                                                      border: "none",
                                                                                                                                                                                                                                                                                                                                                                                                                                                borderRadius: 6,
                                                                                                                                                                                                                                                                                                                                                                                                                                                          cursor: "pointer"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Create Commitment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </button>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    onClick={logout}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            style={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      marginLeft: 10,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                padding: "10px 16px",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          backgroundColor: "#ef4444",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    color: "white",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              border: "none",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        borderRadius: 6,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  cursor: "pointer"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Logout
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </button>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <h2 style={{ marginTop: 30 }}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Your Commitments
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </h2>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {commitments.length === 0 && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p>No commitments yet.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {commitments.map((c) => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              key={c.id}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        style={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    border: "1px solid #ddd",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                padding: 10,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            marginTop: 10,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        borderRadius: 6
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <p><b>{c.text}</b></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <p>Status: {c.status}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p>Duration: {c.duration_type}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ))}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }